# MH-RTOS 核心功能声明 (v1.0.0)
## 1. 项目概述
MH-RTOS 是一款基于 Cortex-M4架构自主研发的轻量级实时操作系统内核。本项目旨在通过从零构建内核，深入掌握嵌入式底层任务管理、上下文切换、O(1) 调度算法及复杂的并发同步机制。系统实现了高度的功能解耦，具备抢占式调度、完备的 IPC 通信及系统级资源保护能力。

## 2. 内核架构与调度子系统
*双堆栈与上下文切换*
 [硬件级隔离]：严格区分 MSP (主栈指针，用于内核与中断) 与 PSP (进程栈指针，用于用户任务)，实现内核空间与用户空间的逻辑隔离，提升系统稳定性。
 [汇编级切换]：编写 `os_cpu.s`，通过 `PendSV` 中断手动保存/恢复 R4-R11 软件帧，利用硬件自动压栈机制处理 R0-R3 等硬件帧，实现毫秒级任务切换。
*O(1) 抢占式调度器*
 [位图优先级算法] (Bitmap Scheduling)：摒弃传统的链表遍历查找，引入 32 位优先级位图 (`PrioBitmap`)。利用 Cortex-M 硬件指令 `__CLZ` (计算前导零)，实现最高优先级任务的 O(1) 极速查找，调度时间恒定，不随任务数量增加而波动。
 [时间片轮转] (Round-Robin)：在同优先级任务间实现了基于 SysTick 的时间片轮转机制，确保同级任务能公平获取 CPU 资源，防止单一任务独占。
*任务管理与生命周期*
 [动态任务创建]：支持通过 `task_create` 动态申请 TCB 与栈空间，实现了任务的创建。
 [状态机流转]：构建了完整的任务状态模型，包括 就绪 (Ready)、阻塞 (Blocked)、挂起 (Suspended) 与 运行 (Running)。
 [阻塞延时机制]：实现了 `os_delay` 接口。任务调用后主动将自己从就绪列表移除并挂入 延时列表 (`DelayedList`)，释放 CPU 权；待 SysTick 计时结束后自动唤醒回就绪列表。彻底摒弃了死循环忙等待模式。

## 3. 任务管理与生命周期
[动态任务创建]：支持通过 task_create 动态申请 TCB 与栈空间，实现了任务的“生”。
[状态机流转]：构建了完整的任务状态模型，包括 就绪 (Ready)、阻塞 (Blocked)、挂起 (Suspended) 与 运行 (Running)。
[阻塞延时机制]：实现了 os_delay 接口。任务调用后主动将自己从就绪列表移除并挂入 延时列表 (DelayedList)，释放 CPU 权；待 SysTick 计时结束后自动唤醒回就绪列表。彻底摒弃了死循环忙等待模式。

## 4. 进程间通信与同步
本内核实现了三种不同维度的通信机制，达成了系统功能的深度解耦：
[计数信号量]
 机制：基于 `sem_create`/`sem_take`/`sem_give` 接口，支持资源计数与同步。
 特性：实现了 等待队列 (`WaitList`) 管理。当资源不足时，请求任务自动挂起；资源释放时，系统自动唤醒等待队列中的最高优先级任务，实现了精准的 “事件驱动” 运行模式。
[邮箱通信]
 机制：基于 `void` 指针传递的 零拷贝 (Zero-Copy) 数据传输。
 特性：
     覆盖写入 (Overwrite)：当邮箱满时，新数据直接覆盖旧数据，确保消费者（如显示任务）永远获取传感器的最新状态。
     模块解耦：采用“发布-订阅”模式，生产者与消费者无需互相持有句柄，仅需面向邮箱编程。
[任务通知]
 机制：一种 超轻量级、点对点 的通信方式。直接利用 TCB 中的 `notify_value` 字段。
 特性：无内存开销，速度最快。支持在 ISR 中快速唤醒特定任务，可作为二值信号量、计数信号量或事件组的替代方案。

## 5. 系统安全与资源保护
[嵌套临界区]
 问题解决：解决了原生 `__disable_irq` 不支持函数嵌套调用的缺陷。
 实现：引入全局计数器 `critical_nesting`。进入临界区时计数加一，退出时减一；仅当计数器归零时才真正开启硬件中断，保障了复杂调用链下的数据原子性。
[调度锁]
 机制：提供 `OSSchedLock` 接口。允许在 不关闭中断 (依然响应 SysTick 和外设中断) 的前提下，暂时禁止任务切换。适用于需要保护长逻辑段但不希望丢失硬件数据的场景。
[内核稳定性防御]
在开发过程中修复了多个底层致命隐患，极大提升了内核鲁棒性：
 链表安全遍历：重构了 `SysTick_Handler` 中的链表遍历逻辑，防止因节点删除导致的迭代器失效和野指针访问。
 死锁防御：在 `os_delay` 等阻塞 API 中增加了调度锁状态检测，禁止在锁定状态下挂起任务，防止系统逻辑死锁。
 启动时序保护：通过 `__disable_irq` 保护系统初始化阶段，防止在 PSP 未就绪前触发 PendSV 导致的 HardFault。
